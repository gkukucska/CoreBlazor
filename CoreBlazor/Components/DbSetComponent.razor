@using System.Linq.Expressions
@using System.Reflection
@using CoreBlazor.Utils
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@typeparam TContext where TContext : Microsoft.EntityFrameworkCore.DbContext
@typeparam TEntity where TEntity : class
@inject IServiceProvider ServiceProvider;
@inject NavigationManager NavigationManager
<Grid TItem="TEntity" DataProvider="GetEntities"
      Class="table table-hover table-bordered table-striped"
      AllowFiltering="true"
      AllowSorting="true"
      AllowPaging="true"
      Responsive="true"
      AllowRowClick="true"
      OnRowDoubleClick="@GoToEntityEditorPage"
      PageSize="20">
    <GridColumns>
        @foreach (var prop in typeof(TEntity).GetProperties().Where(x => x.IsDisplayable()))
        {
            <GridColumn TItem="TEntity" HeaderText="@prop.Name" PropertyName="@prop.Name" Filterable="@IsFilterable(prop)" Sortable="@IsSortable(prop)" SortString="@prop.Name" SortKeySelector="prop.GetMemberAccessExpressionWithConversion<TEntity, IComparable>()">
                @prop.GetValue(@context)
            </GridColumn>
        }
    </GridColumns>
</Grid>

@code {
    private async Task<GridDataProviderResult<TEntity>> GetEntities(GridDataProviderRequest<TEntity> request)
    {
        var entities = ServiceProvider.GetRequiredService<TContext>()
                                      .DbSetWithDisplayableNavigations<TEntity>()
                                      .AsNoTracking()
                                      .WithFiltering(request.Filters)
                                      .WithSorting(request.Sorting);
        return new GridDataProviderResult<TEntity>
        {
            Data = await entities.WithPagination(request).ToListAsync(),
            TotalCount = await entities.CountAsync(),
            PageNumber = request.PageNumber            
        };
    }

    private bool IsFilterable(PropertyInfo prop)
    {
        var context = ServiceProvider.GetRequiredService<TContext>();
        return !context.IsNavigation<TEntity>(prop);
    }

    private bool IsSortable(PropertyInfo prop)
    {
        return typeof(IComparable).IsAssignableFrom(prop.PropertyType);
    }


    private Task GoToEntityEditorPage(GridRowEventArgs<TEntity> args)
    {
        var context = ServiceProvider.GetRequiredService<TContext>();
        var primaryKey = context.Model.FindEntityType(typeof(TEntity))!
            .FindPrimaryKey()
            .Properties
            .Single();
        NavigationManager.NavigateTo($"/DbContext/{typeof(TContext).Name}/DbSet/{typeof(TEntity).Name}/Edit/{primaryKey.PropertyInfo.GetValue(args.Item)}");
        return Task.CompletedTask;
    }
}
