@using CoreBlazor.Authorization
@using CoreBlazor.Interfaces
@using CoreBlazor.Utils
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using System.Linq.Expressions
@typeparam TContext where TContext : DbContext
@typeparam TEntity where TEntity : class, new()
@inject IDbContextFactory<TContext> ContextFactory
@inject NavigationManager NavigationManager
@inject INavigationPathProvider NavigationPathProvider
@inject INotAuthorizedComponentTypeProvider NotAuthorizedComponentTypeProvider

<AuthorizeView Policy="@(Policies<TContext,TEntity>.CanCreate)" Context="AuthorizeContext">
    <Authorized Context="AuthorizeContext">
        <EditForm Model="Entity" OnValidSubmit="OnSaveChanges" @ref="@CreateForm">
            <DataAnnotationsValidator />
            <PropertyEditorComponent TContext="TContext" TEntity="TEntity" Entity="@Entity" />
            <Button Color="ButtonColor.Primary" Type="ButtonType.Submit" Class="m-1">Create</Button>
            <Button Color="ButtonColor.Link" Type="ButtonType.Link" To="@NavigationPathProvider.GetPathToReadEntities(typeof(TContext).Name, typeof(TEntity).Name)" Class="m-1">Go back</Button>
        </EditForm>
    </Authorized>
    <NotAuthorized>
        <DynamicComponent Type="NotAuthorizedComponentTypeProvider.GetNotAuthorizedComponentType<TContext, TEntity>()" />
    </NotAuthorized>
</AuthorizeView>
@code {
    [Parameter]
    public string EntityId { get; set; }

    public TEntity Entity { get; set; }

    public EditForm CreateForm { get; set; }

    protected override void OnParametersSet()
    {
        Entity = new();
        base.OnParametersSet();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        CreateForm?.EditContext?.Validate();
        base.OnAfterRender(firstRender);
    }

    private async Task OnSaveChanges(EditContext args)
    {
        await using var context = await ContextFactory.CreateDbContextAsync();
        foreach (var navigation in context.GetNavigations<TEntity>()
                                          .Select(x => x.PropertyInfo?.GetValue(Entity))
                                          .Where(x => x is not null))
        {
            context.Attach(navigation);
        }
        await context.AddAsync(Entity);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo(NavigationPathProvider.GetPathToReadEntities(typeof(TContext).Name, typeof(TEntity).Name));
    }
}