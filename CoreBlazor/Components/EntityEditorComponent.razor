@using CoreBlazor.Authorization
@using CoreBlazor.Configuration
@using CoreBlazor.Interfaces
@using CoreBlazor.Utils
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.DependencyInjection
@using System.Linq.Expressions
@typeparam TContext where TContext : DbContext
@typeparam TEntity where TEntity : class
@implements IAsyncDisposable
@inject IDbContextFactory<TContext> ContextFactory
@inject NavigationManager NavigationManager
@inject INavigationPathProvider NavigationPathProvider
<AuthorizeView Policy="@(Policies<TContext,TEntity>.CanEdit)" Context="CanEditContext">
    <Authorized Context="CanEditContext">
        <EditForm Model="Entity" OnValidSubmit="OnSaveChanges">
            <DataAnnotationsValidator />
            <PropertyEditorComponent TContext="TContext" TEntity="TEntity" Entity="@Entity" />
            <AuthorizeView Policy="@(Policies<TContext, TEntity>.CanEdit)" Context="AuthorizeContext">
                <Authorized Context="AuthorizeContext">
                    <Button Color="ButtonColor.Primary" Type="ButtonType.Submit" Class="m-1">Save Changes</Button>
                </Authorized>
            </AuthorizeView>
            <AuthorizeView Policy="@(Policies<TContext, TEntity>.CanDelete)" Context="AuthorizeContext">
                <Authorized Context="AuthorizeContext">
                    <Button Color="ButtonColor.Danger" Type="ButtonType.Link" To="@NavigationPathProvider.GetPathToDeleteEntity(typeof(TContext).Name, typeof(TEntity).Name,EntityId)" Class="m-1">
                        <Icon Name="IconName.ExclamationDiamondFill" />
                        Delete
                    </Button>
                </Authorized>
            </AuthorizeView>
            <Button Color="ButtonColor.Link" Type="ButtonType.Link" To="@NavigationPathProvider.GetPathToReadEntities(typeof(TContext).Name, typeof(TEntity).Name)" Class="m-1">Go back</Button>
        </EditForm>
    </Authorized>
    <NotAuthorized>
        <h3>You are not authorized to view this page.</h3>
    </NotAuthorized>
</AuthorizeView>
@code{
    private TContext _context;

    [Parameter]
    public string EntityId { get; set; }

    public TEntity Entity { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        _context = await ContextFactory.CreateDbContextAsync();
        var set = _context.DbSetWithDisplayableNavigations<TEntity>();
        var primarykey = _context.Model.FindEntityType(typeof(TEntity))!.FindPrimaryKey().Properties.Single().PropertyInfo;
        ParameterExpression parameterExpression = Expression.Parameter(typeof(TEntity));
        var property= Expression.Property(parameterExpression, primarykey.Name);
        var filter = ExpressionExtensions.GetExpressionDelegate<TEntity>(parameterExpression,new FilterItem(primarykey.Name,EntityId,FilterOperator.Equals, default));
        Entity = await set.SingleAsync(filter);
        await base.OnParametersSetAsync();
    }

    public async ValueTask DisposeAsync() 
        => await _context.DisposeAsync();

    private async Task OnSaveChanges(EditContext args)
    {
        foreach (var navigation in _context.GetNavigations<TEntity>()
                                           .Select(x=>x.PropertyInfo?.GetValue(Entity))
                                           .Where(x=> x is not null))
        {
            _context.Attach(navigation);
        }
        _context.Attach(Entity);
        _context.Update(Entity);
        await _context.SaveChangesAsync();
        NavigationManager.NavigateTo(NavigationPathProvider.GetPathToReadEntities(typeof(TContext).Name, typeof(TEntity).Name));
    }
}