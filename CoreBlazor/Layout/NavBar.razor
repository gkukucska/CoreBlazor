@inject IEnumerable<DiscoveredContext> DiscoveredContexts
@using BlazorBootstrap
@using CoreBlazor.Authorization
@using CoreBlazor.Configuration
@using CoreBlazor.Interfaces
@using CoreBlazor.Utils
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Reflection
@inject IAuthorizationService AuthorizationService
@inject INavigationPathProvider NavigationPathProvider
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable
<Sidebar Title="CoreBlazor"
         @ref="_sidebar"
         ImageSrc="https://github.com/gkukucska/CoreBlazor/blob/main/CoreBlazor.png?raw=true"
         BadgeText="@($"{Assembly.GetExecutingAssembly().GetName().Version?.ToString(3)}-alpha" ?? "Unknown")"
         DataProvider="SidebarDataProvider"
         WidthUnit="Unit.Px" />
@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }

    private IEnumerable<NavItem>? _navItems;
    private Sidebar _sidebar;

    protected override void OnParametersSet()
    {
        AuthenticationStateProvider.AuthenticationStateChanged+= AuthenticationStateChanged;
        base.OnParametersSet();
    }

    private async void AuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await task;
        await _sidebar.RefreshDataAsync();
    }

    private async Task<SidebarDataProviderResult> SidebarDataProvider(SidebarDataProviderRequest request)
    {
        var user = (await AuthenticationStateTask).User;
        _navItems = await GetNavItems(user).ToListAsync();

        return await Task.FromResult(request.ApplyTo(_navItems));
    }

    private async IAsyncEnumerable<NavItem> GetNavItems(ClaimsPrincipal user)
    {
        foreach (var context in DiscoveredContexts ?? [])
        {
            ConfigurationHelper.DisplayTitles.TryGetValue(context.ContextType.Name, out var contextTitle);
            contextTitle = contextTitle ?? context.ContextType.Name;
            var canReadInfo = await AuthorizationService.AuthorizeAsync(user, Policies.CanReadInfo(context.ContextType));
            if (!canReadInfo.Succeeded)
            {
                continue;
            }
            yield return new NavItem()
            {
                Text = contextTitle,
                IconName = IconName.DatabaseFill,
                Id = context.ContextType.Name
            };
            yield return new NavItem()
            {
                Text = "Info",
                IconName = IconName.InfoCircle,
                Id = context.ContextType.Name+"info",
                Href =  NavigationPathProvider.GetPathToReadDbContextInfo(context.ContextType.Name),
                ParentId = context.ContextType.Name
            };

            foreach (var set in context.Sets)
            {
                var canRead = await AuthorizationService.AuthorizeAsync(user, Policies.CanRead(context.ContextType, set.EntityType));
                if (!canRead.Succeeded)
                {
                    continue;
                }
                ConfigurationHelper.DisplayTitles.TryGetValue(context.ContextType.Name + set.EntityType.Name, out var setTitle);
                setTitle = setTitle ?? set.EntityType.Name;
                yield return new NavItem()
                {
                    Text = setTitle,
                    IconName = IconName.Table,
                    Id = context.ContextType.Name+ set.EntityType.Name,
                    Href = NavigationPathProvider.GetPathToReadEntities(context.ContextType.Name, set.EntityType.Name),
                    ParentId = context.ContextType.Name
                };
            }
        }
    }

    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= AuthenticationStateChanged;
    }
}